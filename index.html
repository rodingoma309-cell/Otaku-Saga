<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Otaku Saga - Connexion</title>
    <link rel="stylesheet" href="auth.css" />
    <style>
      /* petit loader et style message d'erreur */
      .inline-loader {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.9s linear infinite;
        vertical-align: middle;
        margin-left: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      /* forcer message d'erreur en rouge */
      .error-message {
        color: #e74c3c;
      }
    </style>

    <!--Firebase App(core SDK)-->
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js"></script>
    <!--Firebase Auth-->
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js"></script>
  </head>
  <body>
    <div class="auth-container">
      <!-- FORMULAIRE DE CONNEXION -->
      <div class="auth-box" id="loginBox">
        <div class="logo-section">
          <h1 class="app-title">üéå Otaku Saga</h1>
          <p class="app-subtitle">Votre portail vers l'univers des mangas</p>
        </div>

        <form id="loginForm" class="auth-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="email"
              placeholder="votre@email.com"
            />
          </div>

          <div class="form-group">
            <label for="password">Mot de passe</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>

          <button type="submit" class="btn-auth">Se connecter</button>

          <div id="errorMessage" class="error-message"></div>
        </form>

        <div class="auth-footer">
          <p>
            Pas encore de compte ? <a href="#" id="registerLink">S'inscrire</a>
          </p>
          <div
            id="alreadyConnected"
            style="
              display: none;
              margin-top: 20px;
              padding: 15px;
              background: rgba(108, 92, 231, 0.1);
              border-radius: 10px;
              text-align: center;
            "
          >
            <p style="color: #a29bfe; margin-bottom: 10px">
              Vous √™tes d√©j√† connect√©
            </p>
            <a
              href="accueil.html"
              style="color: #6c5ce7; text-decoration: none; font-weight: 600"
              >Aller √† l'accueil ‚Üí</a
            >
          </div>
        </div>
      </div>

      <!-- FORMULAIRE D'INSCRIPTION -->
      <div class="auth-box" id="registerBox" style="display: none">
        <div class="logo-section">
          <h1 class="app-title">üéå Otaku Saga</h1>
          <p class="app-subtitle">Cr√©ez votre compte</p>
        </div>

        <form id="registerForm" class="auth-form">
          <div class="form-group">
            <label for="registerUsername">Nom d'utilisateur</label>
            <input
              type="text"
              id="registerUsername"
              name="username"
              required
              placeholder="Votre pseudo"
              minlength="3"
              maxlength="20"
            />
          </div>

          <div class="form-group">
            <label for="registerEmail">Email</label>
            <input
              type="email"
              id="registerEmail"
              name="email"
              required
              placeholder="votre@email.com"
              autocomplete="email"
            />
          </div>

          <div class="form-group">
            <label for="registerPassword">Mot de passe</label>
            <input
              type="password"
              id="registerPassword"
              name="password"
              required
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              minlength="6"
              autocomplete="new-password"
            />
            <small style="color: #7f8c8d; margin-top: 5px; display: block">
              Minimum 6 caract√®res
            </small>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirmer le mot de passe</label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              required
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              autocomplete="new-password"
            />
          </div>

          <div class="form-group">
            <label for="registerBio">Bio (optionnel)</label>
            <textarea
              id="registerBio"
              name="bio"
              placeholder="Parlez-nous de vous..."
              maxlength="150"
              style="resize: vertical; min-height: 80px"
            ></textarea>
          </div>

          <button type="submit" class="btn-auth">S'inscrire</button>

          <div id="registerErrorMessage" class="error-message"></div>
        </form>

        <div class="auth-footer">
          <p>
            Vous avez d√©j√† un compte ?
            <a href="#" id="loginLink">Se connecter</a>
          </p>
        </div>
      </div>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDmLoRd1Plxm8TVtHQaIumVZuJIFUkND5k",
        authDomain: "donatien-c5fd7.firebaseapp.com",
        projectId: "donatien-c5fd7",
        storageBucket: "donatien-c5fd7.appspot.com",
        messagingSenderId: "96281887961",
        appId: "1:96281887961:web:0752bc0976cbb3012c6ac8",
      };
      // Initialiser Firebase
      firebase.initializeApp(firebaseConfig);
    </script>
    <script src="offline.js"></script>
    <script src="app.js"></script>

    <script>
      // V√©rifie si email existe avant d'essayer de se connecter.
      // Si pas d'email trouv√© : affiche message rouge, redirige vers inscription et pr√©-remplit email.
      (function () {
        const loginForm = document.getElementById("loginForm");
        const errorEl = document.getElementById("errorMessage");

        loginForm?.addEventListener("submit", async function (e) {
          const emailInput = document.getElementById("email");
          const email = (emailInput?.value || "").trim();
          if (!email) return; // laisser app.js g√©rer la validation

          if (!navigator.onLine) {
            // OfflineManager g√®re d√©j√† normalement, mais on assure
            errorEl.textContent =
              "Connexion Internet requise pour vous connecter.";
            e.preventDefault();
            return;
          }

          if (!window.firebase || !firebase.auth) {
            // firebase indisponible ‚Äî laisser app.js g√©rer l'erreur
            return;
          }

          try {
            const methods = await firebase
              .auth()
              .fetchSignInMethodsForEmail(email);
            if (!methods || methods.length === 0) {
              // email non enregistr√© -> emp√™cher submit, afficher message rouge avec loader,
              // basculer vers l'inscription et pr√©-remplir l'email
              e.preventDefault();
              errorEl.innerHTML =
                "Aucun compte trouv√© pour cet email. Redirection vers l'inscription <span class='inline-loader'></span>";
              errorEl.style.color = "#e74c3c";

              setTimeout(() => {
                // basculer UI
                document.getElementById("loginBox").style.display = "none";
                document.getElementById("registerBox").style.display = "block";
                // pr√©-remplir email d'inscription
                const regEmail = document.getElementById("registerEmail");
                const regUsername = document.getElementById("registerUsername");
                if (regEmail) regEmail.value = email;
                if (regUsername) regUsername.focus();
                // message effac√©
                errorEl.textContent = "";
              }, 1200);
            }
            // si methods exist, laisser app.js continuer la tentative de connexion
          } catch (err) {
            // en cas d'erreur (ex: quota), ne bloquer pas la soumission ‚Äî app.js affichera erreur
            console.warn("Erreur v√©rification email:", err);
          }
        });
      })();
    </script>
  </body>
</html>
